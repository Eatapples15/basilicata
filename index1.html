<!DOCTYPE html>
<html lang="it">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestione Mappa Criticità</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
body {
font-family: sans-serif;
display: flex;
flex-wrap: wrap;
gap: 20px;
padding: 20px;
}

#leaflet-map {
flex: 2;
min-width: 500px;
height: 500px;
}

#color-controls {
flex: 1;
min-width: 300px;
display: flex;
flex-direction: column;
gap: 10px;
padding: 20px;
border: 1px solid #ccc;
}

.color-input-group {
display: flex;
align-items: center;
gap: 10px;
}

.color-input-group label {
width: 50px;
}

#save-map {
padding: 10px 15px;
background-color: #4CAF50;
color: white;
border: none;
border-radius: 5px;
cursor: pointer;
font-size: 16px;
margin-top: 20px;
}

#save-map:hover {
background-color: #45a049;
}

.error-message {
color: red;
font-size: 0.8em;
}
</style>
</head>

<body>

<div id="leaflet-map"></div>

<div id="color-controls">
<h2>Imposta Colori Criticità</h2>

<div class="color-input-group">
<label for="color-A1">A1:</label>
<select id="color-A1">
<option value="green">Verde</option>
<option value="yellow">Giallo</option>
<option value="orange">Arancione</option>
<option value="red">Rosso</option>
</select>
<span class="error-message" id="error-A1"></span>
</div>
<div class="color-input-group">
<label for="color-A2">A2:</label>
<select id="color-A2">
<option value="green">Verde</option>
<option value="yellow">Giallo</option>
<option value="orange">Arancione</option>
<option value="red">Rosso</option>
</select>
<span class="error-message" id="error-A2"></span>
</div>
<div class="color-input-group">
<label for="color-B">B:</label>
<select id="color-B">
<option value="green">Verde</option>
<option value="yellow">Giallo</option>
<option value="orange">Arancione</option>
<option value="red">Rosso</option>
</select>
<span class="error-message" id="error-B"></span>
</div>
<div class="color-input-group">
<label for="color-C">C:</label>
<select id="color-C">
<option value="green">Verde</option>
<option value="yellow">Giallo</option>
<option value="orange">Arancione</option>
<option value="red">Rosso</option>
</select>
<span class="error-message" id="error-C"></span>
</div>
<div class="color-input-group">
<label for="color-D">D:</label>
<select id="color-D">
<option value="green">Verde</option>
<option value="yellow">Giallo</option>
<option value="orange">Arancione</option>
<option value="red">Rosso</option>
</select>
<span class="error-message" id="error-D"></span>
</div>
<div class="color-input-group">
<label for="color-E1">E1:</label>
<select id="color-E1">
<option value="green">Verde</option>
<option value="yellow">Giallo</option>
<option value="orange">Arancione</option>
<option value="red">Rosso</option>
</select>
<span class="error-message" id="error-E1"></span>
</div>
<div class="color-input-group">
<label for="color-E2">E2:</label>
<select id="color-E2">
<option value="green">Verde</option>
<option value="yellow">Giallo</option>
<option value="orange">Arancione</option>
<option value="red">Rosso</option>
</select>
<span class="error-message" id="error-E2"></span>
</div>

<button id="save-map">Genera Mappa</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
<script>
const leafletMap = L.map('leaflet-map').setView([40.6393, 15.8054], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(leafletMap);

let geojsonData; // Store GeoJSON data globally
let criticitàMap = {}; // Store criticità mapping
let coloriBase = {};  // Store color mappings
        let geojsonLayer; // Store the GeoJSON layer
        let geojsonLayer = null; // Store the GeoJSON layer - INITIALIZED!

// Fetch GeoJSON data
fetch('limits_R_17_municipalities.geojson')
.then(response => response.json())
.then(data => {
geojsonData = data;  // Store the data
// Initialize the map when data is loaded
initializeMap();
})
.catch(error => console.error("Errore nel caricamento del GeoJSON:", error));

// Function to initialize the map and controls
function initializeMap() {
// Setup criticitàMap (you'll need to adapt this to your data)
const configurazioneCriticità = {
'A1': ["Montemilone", "Atella", "PalazzoSanGervasio", "Pescopagano", "Rapolla", "Rapone", "RioneroinVulture", "Ripacandida", "RuvodelMonte", "SanFele", "Filiano", "Forenza", "Lavello", "Barile", "Maschito", "Melfi", "Venosa", "Ginestra"],
'A2': ["MuroLucano", "Balvano", "Baragiano", "Bella", "Brienza", "Castelgrande", "Picerno", "Ruoti", "SantAngeloLeFratte", "SassodiCastalda", "SatrianodiLucania", "SavoiadiLucania", "Tito", "VietridiPotenza"],
'B': ["Abriola", "Accettura", "Acerenza", "AlbanodiLucania", "Anzi", "Avigliano", "Banzi", "BrindisiMontagna", "Calciano", "Calvello", "Campomaggiore", "Cancellara", "Castelmezzano", "Ferrandina", "Filiano", "Forenza", "Garaguso", "GenzanodiLucania", "Grassano", "Grottole", "Irsina", "Laurenzana", "Miglionico", "OlivetoLucano", "OppidoLucano", "Pietragalla", "Pietrapertosa", "Pignola", "Pomarico", "Potenza", "Salandra", "SanChiricoNuovo", "SanMauroForte", "Tito", "Tolve", "Tricarico", "Trivigno", "VaglioBasilicata", "Matera"],
'C': ["Montemurro", "Aliano", "Armento", "Calvera", "Carbone", "CastronuovodiSantAndrea", "Cersosimo", "Chiaromonte", "Cirigliano", "Colobraro", "CorletoPerticara", "Episcopia", "Fardella", "FrancavillainSinni", "Gallicchio", "Gorgoglione", "GrumentoNova", "GuardiaPerticara", "MarsicoNuovo", "Marsicovetere", "Missanello", "Moliterno", "Noepoli", "Paterno", "Roccanova", "SanChiricoRaparo", "SanCostantinoAlbanese", "SanGiorgioLucano", "SanMartinodAgri", "SanPaoloAlbanese", "SanSeverinoLucano", "SantArcangelo", "Sarconi", "Senise", "Spinoso", "Stigliano", "Teana", "TerranovadiPollino", "Tramutola", "Tursi", "Valsinni", "Viggiano"],
'D': ["Nemoli", "CastelluccioInferiore", "CastelluccioSuperiore", "Castelsaraceno", "Lagonegro", "Latronico", "Lauria", "Maratea", "Rivello", "Rotonda", "Trecchina", "Viggianello"],
'E1': ["NovaSiri", "Policoro", "Rotondella", "ScanzanoJonico", "Tursi", "MontalbanoJonico", "Craco"],
'E2': ["Montescaglioso", "Bernalda", "Pisticci", "Pomarico", "Ferrandina"]
};

for (const base in configurazioneCriticità) {
const comuni = configurazioneCriticità[base];
comuni.forEach(comune => {
criticitàMap[comune] = base;
});
}

// Add event listener to save button
document.getElementById('save-map').addEventListener('click', generateMap);
}

function validateColors() {
let isValid = true;
const colors = ['green', 'yellow', 'orange', 'red'];

document.querySelectorAll('select').forEach(select => {
const color = select.value;
const errorSpan = document.getElementById(`error-${select.id.split('-')[1]}`);
if (!colors.includes(color)) {
errorSpan.textContent = "Colore non valido";
isValid = false;
} else {
errorSpan.textContent = "";
}
});

return isValid;
}

function generateMap() {
if (!validateColors()) {
alert("Correggi gli errori nei colori!");
return;
}

// Clear existing layer if any
if (leafletMap.hasLayer(geojsonLayer)) {
leafletMap.removeLayer(geojsonLayer);
}

// Collect colors from select elements
coloriBase = {};
document.querySelectorAll('select').forEach(select => {
const base = select.id.split('-')[1];
coloriBase[base] = select.value;
});

// Add the GeoJSON layer with the styles
geojsonLayer = L.geoJSON(geojsonData, {
style: styleComune
}).addTo(leafletMap);
}

function styleComune(feature) {
const comuneNome = feature.properties.name;
const criticità = getCriticità(comuneNome);
let fillColor = '#ccc'; // Default color
if (criticità && coloriBase[criticità]) {
fillColor = coloriBase[criticità];
}

// Convert color names to hex codes
let hexColor = fillColor;
switch (fillColor) {
case 'green':
hexColor = '#008000';
break;
case 'yellow':
hexColor = '#FFFF00';
break;
case 'orange':
hexColor = '#FFA500';
break;
case 'red':
hexColor = '#FF0000';
break;
}

return {
fillColor: hexColor,
weight: 1,
opacity: 1,
color: '#333',
fillOpacity: 0.7
};
}

function getCriticità(comuneNome) {
return criticitàMap[comuneNome];
}
</script>
</body>

</html>
