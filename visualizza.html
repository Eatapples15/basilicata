<script>
        // Your web app's Firebase configuration (IDENTICO A index.html)
        const firebaseConfig = {
            apiKey: "AIzaSyD1ABRI99tMtvFbbvjqyjbLImfgNMdRR28",
            authDomain: "bollettinoregionale.firebaseapp.com",
            projectId: "bollettinoregionale",
            databaseURL: "https://bollettinoregionale-default-rtdb.europe-west1.firebasedatabase.app/",
            storageBucket: "bollettinoregionale.appspot.com",
            messagingSenderId: "765538370497",
            appId: "1:765538370497:web:9c4f569754c0df01cc2540",
            // measurementId: "G-0BCQ0VRNXF" // measurementId è opzionale
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const leafletMap = L.map('leaflet-map').setView([40.6393, 15.8054], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(leafletMap);

        const lastUpdatedElement = document.getElementById('last-updated');
        const savePdfButton = document.getElementById('save-pdf-button');

        let criticitàMap = {};
        let coloriBase = {};

        // Normalizzazione dei nomi dei comuni
        function normalizeComuneName(nome) {
            if (!nome) return "";
            let normalized = nome.toLowerCase().trim().replace(/\s+/g, ' ').normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            return normalized;
        }

        // Carica il file GeoJSON (Assicurati che sia disponibile!)
        fetch('limits_R_17_municipalities.geojson')
            .then(response => response.json())
            .then(geojsonData => {
                // Log dei nomi dei comuni dal GeoJSON (NORMALIZZATI)
                console.log("Nomi dei Comuni nel GeoJSON (NORMALIZZATI):");
                geojsonData.features.forEach(feature => {
                    if (feature.properties && feature.properties.name) {
                        let normalizedName = normalizeComuneName(feature.properties.name);
                        console.log(`  - Originale: "${feature.properties.name}", Normalizzato: "${normalizedName}"`);
                        feature.properties.normalizedName = normalizedName; // Aggiungi il nome normalizzato all'oggetto feature
                    }
                });


                // Funzione per recuperare e applicare i colori
                function applyColorsAndDisplay() {
                    database.ref('colori').once('value', snapshot => {
                        if (snapshot.exists()) {
                            const datiColori = snapshot.val();
                            coloriBase = datiColori.coloriBase || {};
                            console.log("Colori Base:", JSON.stringify(coloriBase, null, 2));
                            const timestamp = new Date(datiColori.dataCreazione);
                            const formattedDate = timestamp.toLocaleString();
                            lastUpdatedElement.textContent = `Aggiornato il: ${formattedDate}`;

                            const configurazioneCriticità = {
                                'A1': ["Montemilone", "Atella", "Palazzo San Gervasio", "Pescopagano", "Rapolla", "Rapone", "Rionero in Vulture", "Ripacandida", "Ruvo del Monte", "San Fele", "Filiano", "Forenza", "Lavello", "Barile", "Maschito", "Melfi", "Venosa", "Ginestra"],
                                'A2': ["Muro Lucano", "Balvano", "Baragiano", "Bella", "Brienza", "Castelgrande", "Picerno", "Ruoti", "Sant'Angelo Le Fratte", "Sasso di Castalda", "Satriano di Lucania", "Savoia di Lucania", "Tito", "Vietri di Potenza"],
                                'B': ["Abriola", "Accettura", "Acerenza", "Albano di Lucania", "Anzi", "Avigliano", "Banzi", "Brindisi Montagna", "Calciano", "Calvello", "Campomaggiore", "Cancellara", "Castelmezzano", "Ferrandina", "Filiano", "Forenza", "Garaguso", "Genzano di Lucania", "Grassano", "Grottole", "Irsina", "Laurenzana", "Miglionico", "Oliveto Lucano", "Oppido Lucano", "Pietragalla", "Pietrapertosa", "Pignola", "Pomarico", "Potenza", "Salandra", "San Chirico Nuovo", "San Mauro Forte", "Tito", "Tolve", "Tricarico", "Trivigno", "Vaglio Basilicata", "Matera"],
                                'C': ["Montemurro", "Aliano", "Armento", "Calvera", "Carbone", "Castronuovo di Sant'Andrea", "Cersosimo", "Chiaromonte", "Cirigliano", "Colobraro", "Corleto Perticara", "Episcopia", "Fardella", "Francavilla in Sinni", "Gallicchio", "Gorgoglione", "Grumento Nova", "Guardia Perticara", "Marsico Nuovo", "Marsicovetere", "Missanello", "Moliterno", "Noepoli", "Paterno", "Roccanova", "San Chirico Raparo", "San Costantino Albanese", "San Giorgio Lucano", "San Martino d'Agri", "San Paolo Albanese", "San Severino Lucano", "Sant'Arcangelo", "Sarconi", "Senise", "Spinoso", "Stigliano", "Teana", "Terranova di Pollino", "Tramutola", "Tursi", "Valsinni", "Viggiano"],
                                'D': ["Nemoli", "Castelluccio Inferiore", "Castelluccio Superiore", "Castelsaraceno", "Lagonegro", "Latronico", "Lauria", "Maratea", "Rivello", "Rotonda", "Trecchina", "Viggianello"],
                                'E1': ["Nova Siri", "Policoro", "Rotondella", "Scanzano Jonico", "Tursi", "Montalbano Jonico", "Craco"],
                                'E2': ["Montescaglioso", "Bernalda", "Pisticci", "Pomarico", "Ferrandina"]
                            };

                            // Costruisci la mappa delle criticità (NORMALIZZATA)
                            for (const base in configurazioneCriticità) {
                                const comuni = configurazioneCriticità[base];
                                comuni.forEach(comune => {
                                    const normalizedComune = normalizeComuneName(comune);
                                    criticitàMap[normalizedComune] = base; // APPLICA LA NORMALIZZAZIONE QUI
                                    console.log(`CriticitàMap: "${normalizedComune}" -> ${base}`); // LOG
                                });
                            }

                            L.geoJSON(geojsonData, {
                                style: styleComune,
                                onEachFeature: onEachFeature // Aggiunta la funzione per i popup
                            }).addTo(leafletMap);

                        } else {
                            lastUpdatedElement.textContent = 'Nessun dato colore disponibile.';
                        }
                    }, error => {
                        console.error("Errore nel recupero dei colori:", error);
                        lastUpdatedElement.textContent = 'Errore nel caricamento dei colori.';
                    });
                }

                applyColorsAndDisplay();

                function styleComune(feature) {
                    let normalizedComuneNome = feature.properties.normalizedName; // Usa il nome normalizzato
                    const criticità = getCriticità(normalizedComuneNome);

                    console.log(`styleComune - Comune Normalizzato: "${normalizedComuneNome}", Criticità: ${criticità}`);

                    let fillColor = '#ccc';
                    if (criticità && coloriBase[criticità]) {
                        fillColor = coloriBase[criticità];
                    }

                    console.log(`Colore da Applicare: ${fillColor}`);

                    let hexColor = fillColor;
                    switch (fillColor) {
                        case 'green':
                            hexColor = '#008000';
                            break;
                        case 'yellow':
                            hexColor = '#FFFF00';
                            break;
                        case 'orange':
                            hexColor = '#FFA500';
                            break;
                        case 'red':
                            hexColor = '#FF0000';
                            break;
                        default:
                            hexColor = '#ccc';
                    }

                    return {
                        fillColor: hexColor,
                        weight: 1,
                        opacity: 1,
                        color: '#333',
                        fillOpacity: 0.7 // Mantieni la trasparenza per la visualizzazione nella pagina
                    };
                }

                function getCriticità(comuneNome) {
                    const criticità = criticitàMap[comuneNome];
                    console.log(`getCriticità - Ricerca Criticità per "${comuneNome}": ${criticità}`); // LOG
                    return criticità;
                }

                function onEachFeature(feature, layer) {
                    if (feature.properties && feature.properties.name) {
                        const normalizedComuneNome = feature.properties.normalizedName; // Usa il nome normalizzato
                        const criticità = getCriticità(normalizedComuneNome) || 'Non disponibile';
                        layer.bindPopup(`<b>${feature.properties.name}</b><br>Criticità: ${criticità}`);
                    }
                }

                savePdfButton.addEventListener('click', function () {
                    console.log("Inizio generazione PDF...");

                    // Stili semplificati per il PDF
                    const pdfStyles = {
                        fillColor: '#000', // Colore pieno per i poligoni nel PDF
                        weight: 1,
                        color: '#333',
                        fillOpacity: 1 // Nessuna trasparenza per il PDF
                    };

                    // Applica gli stili semplificati temporaneamente
                    leafletMap.eachLayer(layer => {
                        if (layer instanceof L.GeoJSON) {
                            layer.setStyle(pdfStyles);
                        }
                    });

                    // Forzare il reflow
                    leafletMap.getContainer().style.display;

                    // Aumenta l'attesa
                    setTimeout(function() {
                        console.log("Chiamata leafletImage...");

                        leafletImage(leafletMap, function (err, canvas) {
                            console.log("Callback di leafletImage eseguito.");

                            if (err) {
                                console.error("Errore in leafletImage:", err);
                                return;
                            }

                            const imgData = canvas.toDataURL('image/png');
                            console.log("Dati immagine ottenuti:", imgData.substring(0, 100) + "..."); // Log parziale

                            // Visualizza l'immagine (DEBUG)
                            // const img = document.createElement('img');
                            // img.src = imgData;
                            // document.body.appendChild(img);

                            const { jsPDF } = window.jspdf;
                            const pdf = new jsPDF('landscape');
                            const imgWidth = pdf.internal.pageSize.getWidth() - 20;
                            const imgHeight = (canvas.height * imgWidth) / canvas.width;

                            pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                            pdf.setFontSize(10);
                            pdf.text(lastUpdatedElement.textContent, 10, pdf.internal.pageSize.getHeight() - 10);
                            pdf.save(`bollettino_criticità_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.pdf`);

                            console.log("PDF generato e salvato.");

                            // Ripristina gli stili originali
                            leafletMap.eachLayer(layer => {
                                if (layer instanceof L.GeoJSON) {
                                    layer.setStyle(styleComune);
                                }
                            });

                        });
                    }, 1000); // Aumenta l'attesa a 1 secondo
                });
            });
    </script>
