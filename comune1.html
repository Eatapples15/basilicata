<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Criticità del Comune</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            justify-content: center;
            align-items: flex-start;
            background-color: #f0f2f5;
        }

        #main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }

        #info-panel {
            flex: 1;
            min-width: 300px;
            max-width: 350px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 25px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }

        #map-container {
            flex: 2;
            min-width: 450px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #leaflet-map {
            height: 600px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2 {
            color: #333;
            margin-bottom: 10px;
        }

        p {
            color: #555;
            line-height: 1.6;
        }

        strong {
            color: #000;
        }

        #comune-name-display {
            font-size: 1.8em;
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 5px;
        }

        #comune-criticity-display {
            font-size: 1.4em;
            font-weight: bold;
            color: #dc3545;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        #info-message {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }

        #last-updated {
            font-style: italic;
            color: #777;
            margin-top: 10px;
            font-size: 0.9em;
        }

        #region-logo {
            width: 100%;
            max-width: 180px;
            height: auto;
            margin-top: auto;
            align-self: center;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        /* Stili per i popup di Leaflet */
        .leaflet-popup-content-wrapper {
            background-color: white;
            color: #333;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .leaflet-popup-content {
            margin: 0;
        }

        .leaflet-popup-tip-container {
            width: 20px;
            height: 10px;
        }

        .leaflet-popup-tip {
            background: white;
            border: 1px solid #aaa;
            border-top-color: transparent;
            border-left-color: transparent;
        }

        /* Stili per le sezioni informative aggiuntive */
        .info-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .info-section h3 {
            color: #333;
            margin-bottom: 10px;
        }

        ul {
            list-style-type: disc;
            margin-left: 20px;
            color: #666;
        }

        ul li {
            margin-bottom: 5px;
        }

        /* Stili per il pulsante di navigazione */
        #navigation-button {
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            margin-top: 15px;
            align-self: center;
        }

        #navigation-button:hover {
            background-color: #218838;
        }

        /* Nuovo stile per il selettore dei rischi */
        #risk-selector-container {
            margin-bottom: 15px;
        }

        #risk-selector-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        #risk-selector {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            background-color: #f9f9f9;
        }

        /* Stili per la legenda dei rischi (preview) */
        #risk-legend {
            background-color: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            min-width: 450px;
            max-width: 700px;
        }

        #risk-legend h3 {
            margin-top: 0;
            color: #333;
            font-size: 1.2em;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }

        .legend-item:hover {
            background-color: #f0f0f0;
        }

        .legend-color-box {
            width: 25px;
            height: 25px;
            border: 1px solid #888;
            margin-right: 10px;
            border-radius: 3px;
        }

        .legend-text {
            font-size: 1em;
            color: #555;
            flex-grow: 1;
        }

        .legend-item.active {
            background-color: #e0f2f7;
            /* Sfondo leggermente colorato per l'elemento attivo */
            border: 1px solid #007bff;
            /* Bordo più evidente per l'elemento selezionato */
        }

        .legend-item.active .legend-color-box {
            border: 2px solid #0056b3;
            /* Bordo più evidente per l'elemento selezionato */
        }
    </style>
</head>

<body>

    <div id="main-content">
        <div id="info-panel">
            <h1 id="comune-name-display"></h1>
            <p id="comune-criticity-display"></p>
            <p id="info-message"></p>
            <p id="last-updated"></p>

            <div class="info-section" id="risk-selector-container">
                <label for="risk-selector">Seleziona Tipo di Rischio:</label>
                <select id="risk-selector">
                </select>
            </div>

            <div class="info-section">
                <h2>Informazioni sul Rischio Territoriale</h2>
                <p id="risk-info">Caricamento informazioni sui rischi...</p>
            </div>

            <div class="info-section">
                <h2>Aree di Accoglienza / Punti di Raccolta</h2>
                <p id="shelter-info">Caricamento informazioni sulle aree di accoglienza...</p>
            </div>

            <button id="navigation-button">
                Naviga all'area di accoglienza più vicina
            </button>

            <img src="Logo regione.png" alt="Logo Regione Basilicata" id="region-logo">
        </div>

        <div id="map-container">
            <div id="leaflet-map"></div>
            <div id="risk-legend">
                <h3>Legenda Rischi del Comune</h3>
                <div id="legend-items-container">
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // Your web app's Firebase configuration
        // **ATTENZIONE**: Sostituisci "YOUR_FIREBASE_API_KEY" con la tua VERA API Key di Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD1ABRI99tMtvFbbvjqyjbLImfgNMdRR28", // <-- SOSTITUISCI CON LA TUA CHIAVE API (la stessa di admin.html)
            authDomain: "bollettinoregionale.firebaseapp.com",
            projectId: "bollettinoregionale",
            databaseURL: "https://bollettinoregionale-default-rtdb.europe-west1.firebasedatabase.app/",
            storageBucket: "bollettinoregionale.appspot.com",
            messagingSenderId: "765538370497",
            appId: "1:765538370497:web:9c4f569754c0df01cc2540",
            // measurementId: "G-0BCQ0VRNXF" // measurementId è opzionale
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const comuniRef = database.ref('comuni_data'); // Riferimento al nodo dei dati dei comuni
        const coloriRef = database.ref('colori'); // Riferimento al nodo dei colori

        const leafletMap = L.map('leaflet-map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(leafletMap);

        // Elementi HTML
        const pageTitle = document.getElementById('page-title');
        const comuneNameDisplay = document.getElementById('comune-name-display');
        const comuneCriticityDisplay = document.getElementById('comune-criticity-display');
        const infoMessage = document.getElementById('info-message');
        const lastUpdatedElement = document.getElementById('last-updated');
        const riskInfoElement = document.getElementById('risk-info');
        const shelterInfoElement = document.getElementById('shelter-info');
        const navigationButton = document.getElementById('navigation-button');
        const riskSelector = document.getElementById('risk-selector');
        const riskLegendContainer = document.getElementById('legend-items-container');

        let geojsonDataGlobal = null;
        let criticitàMap = {}; // Mappa dei comuni normalizzati alle loro criticità (es. 'A1', 'B')
        let coloriBase = {}; // Mappa delle criticità ai nomi dei colori (es. 'A1' -> 'green')
        let currentComuneNormalizedName = null;
        let currentComuneFeature = null; // Memorizza la feature GeoJSON del comune corrente
        let currentComuneFirebaseData = null; // NUOVO: Dati del comune corrente da Firebase

        // Layer per i controlli e la visualizzazione
        let baseLayers = {};
        let overlays = {};
        let comuneOutlineLayer = null; // Layer per il bordo del comune
        let criticitàFillLayer = null; // Layer per il riempimento "base" del comune
        let emergencyMarkersLayer = new L.LayerGroup(); // Layer per i marker di emergenza/accoglienza
        let riskSpecificFillLayer = new L.LayerGroup(); // Layer per il riempimento specifico del rischio

        // Normalizzazione dei nomi dei comuni: rimuove accenti, rende minuscolo, rimuove spazi extra
        function normalizeComuneName(nome) {
            if (!nome) return "";
            return nome.toLowerCase().trim().replace(/\s+/g, ' ').normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        // Funzione per ottenere il colore esadecimale dal nome del colore
        function getHexColor(colorName) {
            switch (colorName.toLowerCase()) { // Assicurati che il nome sia minuscolo
                case 'green': return '#008000';
                case 'yellow': return '#FFFF00';
                case 'orange': return '#FFA500';
                case 'red': return '#FF0000';
                case 'blue': return '#0000FF';
                case 'purple': return '#800080';
                case 'brown': return '#A52A2A';
                default:
                    console.warn(`Colore non riconosciuto: ${colorName}. Usando grigio di default.`);
                    return '#ccc'; // Grigio di default
            }
        }

        // Funzione per definire lo stile di un comune sulla mappa (solo bordo)
        function styleComuneOutline(feature) {
            return {
                fillColor: 'transparent',
                weight: 3,
                opacity: 1,
                color: 'black',
                fillOpacity: 0
            };
        }

        // Funzione per definire lo stile del riempimento di criticità (colore della base generale del comune)
        function styleCriticitàFill(feature) {
            let normalizedComuneNome = feature.properties.normalizedName;
            const criticità = criticitàMap[normalizedComuneNome];
            const fillColorName = coloriBase[criticità]; // Ottieni il nome del colore (es. 'green')
            const hexColor = getHexColor(fillColorName); // Ottieni il codice esadecimale

            console.log(`[styleCriticitàFill] Comune: ${feature.properties.name}, Criticità: ${criticità}, Nome Colore: ${fillColorName}, Colore Hex: ${hexColor}`);

            return {
                fillColor: hexColor,
                weight: 0, // Nessun bordo visibile per il riempimento
                opacity: 0, // Inizialmente trasparente per il bordo del riempimento
                color: 'transparent',
                fillOpacity: 0.9 // Opacità del riempimento
            };
        }

        // Funzione per definire lo stile del riempimento per un rischio specifico (usando il colore della base generale)
        function styleSpecificRiskFill(feature) {
            // Per la logica attuale, i rischi specifici usano lo stesso colore della criticità generale del comune.
            // Se in futuro avrai criticità/colori specifici per ogni tipo di rischio, questa funzione andrà modificata.
            let normalizedComuneNome = feature.properties.normalizedName;
            const criticità = criticitàMap[normalizedComuneNome];
            const fillColorName = coloriBase[criticità];
            const hexColor = getHexColor(fillColorName);

            console.log(`[styleSpecificRiskFill] Comune: ${feature.properties.name}, Criticità: ${criticità}, Nome Colore: ${fillColorName}, Colore Hex: ${hexColor}`);

            return {
                fillColor: hexColor,
                weight: 0,
                opacity: 0,
                color: 'transparent',
                fillOpacity: 0.9
            };
        }

        // Funzione per gestire i popup
        function onEachFeature(feature, layer) {
            if (feature.properties && feature.properties.name) {
                const normalizedComuneNome = feature.properties.normalizedName;
                const criticità = criticitàMap[normalizedComuneNome] || 'Non disponibile';
                layer.bindPopup(`<b>${feature.properties.name}</b><br>Base: ${criticità}`);
            }
        }

        // Funzione per recuperare il nome del comune dall'URL
        function getComuneFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const comune = params.get('comune');
            return comune ? decodeURIComponent(comune) : null;
        }

        // Definisci le icone personalizzate per i marker
        const shelterIcon = L.icon({
            iconUrl: 'ico/cluster_shelter_32px_icon_bluebox.png', // Assicurati che il percorso sia corretto
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32],
            shadowUrl: 'ico/marker-shadow.png',
            shadowSize: [41, 41]
        });

        const emergencyIcon = L.icon({
            iconUrl: 'ico/disaster_earthquake_32px_icon_bluebox.png', // Assicurati che il percorso sia corretto
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32],
            shadowUrl: 'ico/marker-shadow.png',
            shadowSize: [41, 41]
        });

        // Carica dati GeoJSON e tutti i dati dei comuni e colori da Firebase all'avvio
        Promise.all([
            fetch('limits_R_17_municipalities.geojson').then(res => res.json()),
            coloriRef.once('value'), // Carica i colori base
            comuniRef.once('value') // Carica tutti i dati dei comuni
        ]).then(([geojsonData, coloriSnapshot, comuniDataSnapshot]) => {
            geojsonDataGlobal = geojsonData;

            // Normalizza i nomi dei comuni nel GeoJSON
            geojsonDataGlobal.features.forEach(feature => {
                if (feature.properties && feature.properties.name) {
                    feature.properties.normalizedName = normalizeComuneName(feature.properties.name);
                }
            });

            if (coloriSnapshot.exists()) {
                const datiColori = coloriSnapshot.val();
                coloriBase = datiColori.coloriBase || {};
                const timestamp = new Date(datiColori.dataCreazione);
                lastUpdatedElement.textContent = `Dati colori aggiornati il: ${timestamp.toLocaleString()}`;
            } else {
                lastUpdatedElement.textContent = 'Nessun dato colore disponibile da Firebase.';
                console.warn("Nessun dato colore trovato in Firebase.");
            }

            // Processa i dati dei comuni caricati da Firebase
            if (comuniDataSnapshot.exists()) {
                window.allComuniFirebaseData = comuniDataSnapshot.val(); // Rendi accessibile globalmente
                console.log("Dati di tutti i comuni da Firebase:", window.allComuniFirebaseData);

                // Popola la criticitàMap dai dati di Firebase
                for (const normalizedName in window.allComuniFirebaseData) {
                    criticitàMap[normalizedName] = window.allComuniFirebaseData[normalizedName].criticitàBase || 'Non disponibile';
                }
                console.log("Criticità Map popolata da Firebase:", criticitàMap);

                const targetComuneNome = getComuneFromUrl();
                if (targetComuneNome) {
                    displayComuneInfo(targetComuneNome);
                } else {
                    infoMessage.textContent = "Nessun comune specificato nell'URL. Utilizza '?comune=NomeComune'.";
                    comuneNameDisplay.textContent = "Comune non specificato";
                    comuneCriticityDisplay.textContent = "";
                    riskInfoElement.textContent = "Nessuna informazione disponibile.";
                    shelterInfoElement.textContent = "Nessuna informazione disponibile.";
                    leafletMap.setView([40.6393, 15.8054], 8);
                    document.getElementById('risk-selector-container').style.display = 'none';
                    document.getElementById('risk-legend').style.display = 'none';
                    navigationButton.style.display = 'none';
                }

            } else {
                infoMessage.textContent = 'Nessun dato dei comuni disponibile da Firebase.';
                console.warn("Nessun dato dei comuni trovato in Firebase.");
            }
        }).catch(error => {
            console.error("Errore nel caricamento dei dati:", error);
            infoMessage.textContent = 'Errore nel caricamento dei dati. Riprova più tardi.';
        });


        // Funzione per popolare il selettore dei rischi (aggiornata per usare currentComuneFirebaseData)
        function populateRiskSelector(comuneNormalizedName) {
            riskSelector.innerHTML = '';
            const comuneInfo = currentComuneFirebaseData; // Ora prendiamo i dati dal comune caricato

            if (comuneInfo && comuneInfo.rischi) {
                document.getElementById('risk-selector-container').style.display = 'block';

                const defaultOption = document.createElement('option');
                defaultOption.value = 'generale';
                defaultOption.textContent = 'Rischio Generale';
                riskSelector.appendChild(defaultOption);

                for (const riskType in comuneInfo.rischi) {
                    if (riskType !== 'generale') {
                        const option = document.createElement('option');
                        option.value = riskType;
                        option.textContent = riskType.charAt(0).toUpperCase() + riskType.slice(1).replace(/([A-Z])/g, ' $1').trim();
                        riskSelector.appendChild(option);
                    }
                }
                riskSelector.value = 'generale';
            } else {
                const noOption = document.createElement('option');
                noOption.value = '';
                noOption.textContent = 'Nessun rischio specifico disponibile';
                riskSelector.appendChild(noOption);
                document.getElementById('risk-selector-container').style.display = 'none';
            }
        }

        // Funzione per aggiornare il testo del rischio e la colorazione della mappa (aggiornata)
        function updateRiskInfoAndMapDisplay(selectedRiskType) {
            const comuneInfo = currentComuneFirebaseData; // Ora prendiamo i dati dal comune caricato
            if (comuneInfo && comuneInfo.rischi && comuneInfo.rischi[selectedRiskType]) {
                riskInfoElement.textContent = comuneInfo.rischi[selectedRiskType];
            } else {
                riskInfoElement.textContent = "Informazioni sul rischio non disponibili per il tipo selezionato.";
            }
            updateMapColoration(selectedRiskType);

            // Aggiorna lo stato "active" nella legenda
            document.querySelectorAll('.legend-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeLegendItem = document.querySelector(`.legend-item[data-risk-type="${selectedRiskType}"]`);
            if (activeLegendItem) {
                activeLegendItem.classList.add('active');
            }
        }

        // Event listener per il cambio del rischio nel selettore
        riskSelector.addEventListener('change', (event) => {
            updateRiskInfoAndMapDisplay(event.target.value);
        });

        // Funzione per aggiornare la colorazione della mappa in base al rischio selezionato
        function updateMapColoration(selectedRiskType) {
            // Rimuovi tutti i layer specifici per rischio precedentemente aggiunti
            riskSpecificFillLayer.clearLayers();

            if (currentComuneFeature) {
                // Rimuovi il layer di criticità generale prima di aggiungere quello specifico o rimettere il generale
                if (criticitàFillLayer && leafletMap.hasLayer(criticitàFillLayer)) {
                    leafletMap.removeLayer(criticitàFillLayer);
                }

                if (selectedRiskType === 'generale') {
                    console.log("[updateMapColoration] Visualizzo Criticità Generale.");
                    if (criticitàFillLayer) {
                        criticitàFillLayer.addTo(leafletMap); // Riaggiungi il layer generale
                    }
                } else {
                    console.log(`[updateMapColoration] Visualizzo Rischio Specifico: ${selectedRiskType}.`);
                    // Per qualsiasi altro rischio, colora il comune con il colore della sua criticità generale
                    const newRiskLayer = L.geoJSON(currentComuneFeature, {
                        style: styleSpecificRiskFill, // Usa lo stile specifico per i rischi
                        onEachFeature: onEachFeature
                    });
                    riskSpecificFillLayer.addLayer(newRiskLayer);
                    riskSpecificFillLayer.addTo(leafletMap);
                }
            } else {
                console.warn("[updateMapColoration] currentComuneFeature non disponibile.");
            }
        }

        // Funzione per popolare la legenda dei rischi (aggiornata)
        function populateRiskLegend(comuneNormalizedName) {
            riskLegendContainer.innerHTML = '';
            const comuneInfo = currentComuneFirebaseData; // Ora prendiamo i dati dal comune caricato

            if (comuneInfo && comuneInfo.rischi) {
                document.getElementById('risk-legend').style.display = 'block';

                const criticità = criticitàMap[comuneNormalizedName]; // Prende da criticitàMap popolata da Firebase
                const colorHex = getHexColor(coloriBase[criticità] || '#ccc');

                const generalItem = document.createElement('div');
                generalItem.classList.add('legend-item');
                generalItem.setAttribute('data-risk-type', 'generale');
                generalItem.innerHTML = `
                    <div class="legend-color-box" style="background-color: ${colorHex};"></div>
                    <span class="legend-text">Rischio Generale: ${criticità}</span>
                `;
                generalItem.addEventListener('click', () => {
                    riskSelector.value = 'generale';
                    updateRiskInfoAndMapDisplay('generale');
                });
                riskLegendContainer.appendChild(generalItem);

                for (const riskType in comuneInfo.rischi) {
                    if (riskType !== 'generale') {
                        const item = document.createElement('div');
                        item.classList.add('legend-item');
                        item.setAttribute('data-risk-type', riskType);
                        item.innerHTML = `
                            <div class="legend-color-box" style="background-color: ${colorHex};"></div>
                            <span class="legend-text">${riskType.charAt(0).toUpperCase() + riskType.slice(1).replace(/([A-Z])/g, ' $1').trim()}</span>
                        `;
                        item.addEventListener('click', () => {
                            riskSelector.value = riskType;
                            updateRiskInfoAndMapDisplay(riskType);
                        });
                        riskLegendContainer.appendChild(item);
                    }
                }
            } else {
                document.getElementById('risk-legend').style.display = 'none';
            }
        }

        // Funzione displayComuneInfo (aggiornata per usare currentComuneFirebaseData)
        async function displayComuneInfo(comuneOriginalName) {
            const normalizedComuneName = normalizeComuneName(comuneOriginalName);
            currentComuneNormalizedName = normalizedComuneName;
            console.log(`[displayComuneInfo] Comune originale: ${comuneOriginalName}, Normalizzato: ${normalizedComuneName}`);

            const foundFeature = geojsonDataGlobal.features.find(feature =>
                feature.properties.normalizedName === normalizedComuneName
            );

            // Rimuovi layer esistenti prima di aggiungerne di nuovi
            if (comuneOutlineLayer) leafletMap.removeLayer(comuneOutlineLayer);
            if (criticitàFillLayer) leafletMap.removeLayer(criticitàFillLayer);
            emergencyMarkersLayer.clearLayers();
            riskSpecificFillLayer.clearLayers();
            if (leafletMap.hasLayer(L.control.layers)) { // Rimuovi il controllo layer esistente
                leafletMap.removeControl(L.control.layers);
            }
            overlays = {}; // Reset overlays

            if (foundFeature) {
                currentComuneFeature = foundFeature;
                pageTitle.textContent = `Criticità del Comune di ${foundFeature.properties.name}`;
                comuneNameDisplay.textContent = `Comune: ${foundFeature.properties.name}`;

                // RECUPERA I DATI SPECIFICI DEL COMUNE DA FIREBASE
                const comuneFirebaseSnapshot = await comuniRef.child(normalizedComuneName).once('value');
                currentComuneFirebaseData = comuneFirebaseSnapshot.val(); // Salva i dati nella variabile globale

                if (currentComuneFirebaseData) {
                    const criticità = currentComuneFirebaseData.criticitàBase || 'Non disponibile';
                    comuneCriticityDisplay.textContent = `Base: ${criticità}`;
                    console.log(`[displayComuneInfo] Criticità trovata per ${foundFeature.properties.name}: ${criticità}`);

                    // Crea i layer per il bordo e il riempimento del comune
                    comuneOutlineLayer = L.geoJSON(currentComuneFeature, {
                        style: styleComuneOutline,
                        onEachFeature: onEachFeature
                    });
                    criticitàFillLayer = L.geoJSON(currentComuneFeature, {
                        style: styleCriticitàFill,
                        onEachFeature: onEachFeature
                    });

                    comuneOutlineLayer.addTo(leafletMap);
                    criticitàFillLayer.addTo(leafletMap);
                    leafletMap.fitBounds(comuneOutlineLayer.getBounds().pad(0.5));

                    // Popola selettore rischi, legenda e mostra info
                    populateRiskSelector(normalizedComuneName);
                    populateRiskLegend(normalizedComuneName);
                    updateRiskInfoAndMapDisplay(riskSelector.value); // Inizializza con il rischio generale

                    shelterInfoElement.textContent = currentComuneFirebaseData.accoglienza || "Informazioni aree accoglienza non disponibili.";

                    // Visualizza i punti mappa da Firebase
                    if (currentComuneFirebaseData.puntiMappa && currentComuneFirebaseData.puntiMappa.length > 0) {
                        currentComuneFirebaseData.puntiMappa.forEach(punto => {
                            let markerIcon;
                            if (punto.tipo === 'raccolta') {
                                markerIcon = emergencyIcon;
                            } else if (punto.tipo === 'accoglienza') {
                                markerIcon = shelterIcon;
                            } else {
                                markerIcon = L.Icon.Default; // Fallback
                            }

                            const marker = L.marker([punto.lat, punto.lon], { icon: markerIcon })
                                .bindPopup(`<b>${punto.nome}</b><br>Tipo: ${punto.tipo}`);
                            emergencyMarkersLayer.addLayer(marker);
                        });
                        overlays["Aree di Emergenza/Accoglienza"] = emergencyMarkersLayer;
                        emergencyMarkersLayer.addTo(leafletMap);

                        // Abilita il pulsante di navigazione solo se ci sono punti
                        navigationButton.removeEventListener('click', navigateToShelter); // Evita duplicati
                        navigationButton.addEventListener('click', navigateToShelter);
                        navigationButton.style.display = 'block';

                    } else {
                        shelterInfoElement.textContent += " (Nessun punto specifico su mappa disponibile).";
                        navigationButton.style.display = 'none';
                    }

                } else {
                    // Dati del comune non trovati in Firebase
                    comuneCriticityDisplay.textContent = "Base: Non disponibile";
                    riskInfoElement.textContent = "Informazioni sui rischi non disponibili per questo comune.";
                    shelterInfoElement.textContent = "Informazioni sulle aree di accoglienza non disponibili per questo comune.";
                    navigationButton.style.display = 'none';
                    document.getElementById('risk-selector-container').style.display = 'none';
                    document.getElementById('risk-legend').style.display = 'none';
                    infoMessage.textContent = 'Dati dettagliati non trovati in Firebase per questo comune.';

                    // Mostra solo il bordo del comune
                    comuneOutlineLayer = L.geoJSON(currentComuneFeature, {
                        style: styleComuneOutline,
                        onEachFeature: onEachFeature
                    }).addTo(leafletMap);
                    leafletMap.fitBounds(comuneOutlineLayer.getBounds().pad(0.5));
                }

                // Aggiungi i controlli layer alla mappa solo se ci sono overlays da mostrare
                if (Object.keys(overlays).length > 0 || Object.keys(baseLayers).length > 0) {
                    L.control.layers(baseLayers, overlays).addTo(leafletMap);
                }


            } else {
                pageTitle.textContent = "Comune non trovato";
                comuneNameDisplay.textContent = "Comune non trovato";
                comuneCriticityDisplay.textContent = "";
                infoMessage.textContent = "Il comune specificato nell'URL non è stato trovato nel GeoJSON.";
                riskInfoElement.textContent = "Nessuna informazione disponibile.";
                shelterInfoElement.textContent = "Nessuna informazione disponibile.";
                leafletMap.setView([40.6393, 15.8054], 8); // Centra sulla Basilicata
                document.getElementById('risk-selector-container').style.display = 'none';
                document.getElementById('risk-legend').style.display = 'none';
                navigationButton.style.display = 'none';
            }
        }

        // Funzione per navigare all'area di accoglienza più vicina (o al primo punto mappa)
        function navigateToShelter() {
            if (currentComuneFirebaseData && currentComuneFirebaseData.puntiMappa && currentComuneFirebaseData.puntiMappa.length > 0) {
                const firstPoint = currentComuneFirebaseData.puntiMappa[0];
                const destination = `${firstPoint.lat},${firstPoint.lon}`;
                const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${destination}`;
                window.open(googleMapsUrl, '_blank');
            } else {
                alert("Nessun punto di accoglienza disponibile per la navigazione.");
            }
        }
    </script>

</body>

</html>
